name: ğŸ® Party Games CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Code Quality & Linting
  # ============================================================================
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ¨ Check Prettier formatting
        run: npm run format:check
        
      - name: ğŸ” Run ESLint
        run: npm run lint
        
      - name: ğŸ“ Type check all workspaces
        run: npm run type-check

  # ============================================================================
  # Shared Types Testing
  # ============================================================================
  shared-types:
    name: ğŸ”— Shared Types
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build shared types
        run: npm run build --workspace=shared
        
      - name: ğŸ“ Type check shared
        run: npm run type-check --workspace=shared

  # ============================================================================
  # Backend Testing & Build
  # ============================================================================
  backend:
    name: ğŸ–¥ï¸ Backend Tests
    runs-on: ubuntu-latest
    needs: [shared-types]
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run backend tests
        run: npm run test --workspace=backend
        
      - name: ğŸ—ï¸ Build backend
        run: npm run build --workspace=backend
        
      - name: ğŸ” Test backend health endpoint
        run: |
          cd backend
          npm start &
          SERVER_PID=$!
          sleep 5
          
          # Test health endpoint
          curl -f http://localhost:3001/health || exit 1
          
          # Kill server
          kill $SERVER_PID

  # ============================================================================
  # Frontend Testing & Build
  # ============================================================================
  frontend:
    name: ğŸ¨ Frontend Tests
    runs-on: ubuntu-latest
    needs: [shared-types]
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run frontend tests
        run: npm run test --workspace=frontend
        
      - name: ğŸ—ï¸ Build frontend
        run: npm run build --workspace=frontend
        
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-node${{ matrix.node-version }}
          path: frontend/dist
          retention-days: 7

  # ============================================================================
  # Integration Testing
  # ============================================================================
  integration:
    name: ğŸ¯ Integration Tests
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ“¤ Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-node18
          path: frontend/dist
          
      - name: ğŸš€ Start servers
        run: |
          # Start backend
          cd backend && npm start &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          
          # Start frontend
          cd frontend && npm run preview &
          FRONTEND_PID=$!
          echo "FRONTEND_PID=$FRONTEND_PID" >> $GITHUB_ENV
          
          # Wait for servers to start
          sleep 10
          
      - name: ğŸ§ª Test API endpoints
        run: |
          # Test backend health
          curl -f http://localhost:3001/health
          
          # Test frontend is serving
          curl -f http://localhost:4173
          
      - name: ğŸ§ª Test WebSocket connection
        run: |
          # Install wscat for WebSocket testing
          npm install -g wscat
          
          # Test WebSocket connection (basic connectivity)
          timeout 10s wscat -c ws://localhost:3001 --execute '{"type":"ping"}' || echo "WebSocket test completed"
          
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          # Kill servers
          kill $BACKEND_PID $FRONTEND_PID 2>/dev/null || true

  # ============================================================================
  # Game Logic Testing
  # ============================================================================
  game-logic:
    name: ğŸ² Game Logic Tests
    runs-on: ubuntu-latest
    needs: [shared-types]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ¯ Test Two Truths and a Lie
        run: |
          cd backend
          npm test -- --testNamePattern="TwoTruthsAndALie"
          
      - name: ğŸ¤” Test Would You Rather
        run: |
          cd backend
          npm test -- --testNamePattern="WouldYouRather"
          
      - name: ğŸ¨ Test Quick Draw
        run: |
          cd backend
          npm test -- --testNamePattern="QuickDraw"

  # ============================================================================
  # Performance & Security
  # ============================================================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ” Run npm audit
        run: npm audit --audit-level=high
        
      - name: ğŸ›¡ï¸ Check for vulnerabilities
        run: |
          # Check backend dependencies
          cd backend && npm audit --audit-level=moderate
          
          # Check frontend dependencies  
          cd ../frontend && npm audit --audit-level=moderate

  # ============================================================================
  # Summary Status Check
  # ============================================================================
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [code-quality, backend, frontend, integration, game-logic, security]
    if: always()
    
    steps:
      - name: ğŸ‰ All checks passed
        if: ${{ needs.code-quality.result == 'success' && needs.backend.result == 'success' && needs.frontend.result == 'success' && needs.integration.result == 'success' && needs.game-logic.result == 'success' && needs.security.result == 'success' }}
        run: |
          echo "ğŸ® All Party Games CI checks passed! ğŸ‰"
          echo "âœ… Code Quality"
          echo "âœ… Backend Tests (Node 18 & 20)"
          echo "âœ… Frontend Tests (Node 18 & 20)" 
          echo "âœ… Integration Tests"
          echo "âœ… Game Logic Tests"
          echo "âœ… Security Scan"
          
      - name: âŒ Some checks failed
        if: ${{ needs.code-quality.result != 'success' || needs.backend.result != 'success' || needs.frontend.result != 'success' || needs.integration.result != 'success' || needs.game-logic.result != 'success' || needs.security.result != 'success' }}
        run: |
          echo "âŒ Some CI checks failed:"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Integration: ${{ needs.integration.result }}"
          echo "Game Logic: ${{ needs.game-logic.result }}"
          echo "Security: ${{ needs.security.result }}"
          exit 1 
