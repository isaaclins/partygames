name: ğŸ² Game Testing Suite

on:
  push:
    paths:
      - 'backend/src/games/**'
      - 'frontend/src/games/**'
      - 'shared/types/**'
  pull_request:
    paths:
      - 'backend/src/games/**'
      - 'frontend/src/games/**'
      - 'shared/types/**'
  schedule:
    # Run comprehensive game tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # ============================================================================
  # Two Truths and a Lie Testing
  # ============================================================================
  test-two-truths:
    name: ğŸ­ Two Truths and a Lie
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ­ Test game initialization
        run: |
          cd backend
          npm test -- --testNamePattern="TwoTruthsAndALie.*initialization"
          
      - name: ğŸ“ Test statement submission
        run: |
          cd backend
          npm test -- --testNamePattern="TwoTruthsAndALie.*statement.*submission"
          
      - name: ğŸ—³ï¸ Test voting mechanics
        run: |
          cd backend
          npm test -- --testNamePattern="TwoTruthsAndALie.*voting"
          
      - name: ğŸ† Test scoring system
        run: |
          cd backend
          npm test -- --testNamePattern="TwoTruthsAndALie.*scoring"
          
      - name: ğŸ¯ Test game completion
        run: |
          cd backend
          npm test -- --testNamePattern="TwoTruthsAndALie.*completion"

  # ============================================================================
  # Would You Rather Testing
  # ============================================================================
  test-would-you-rather:
    name: ğŸ¤” Would You Rather
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ¤” Test scenario creation
        run: |
          cd backend
          npm test -- --testNamePattern="WouldYouRather.*scenario.*creation"
          
      - name: ğŸ”„ Test round progression
        run: |
          cd backend
          npm test -- --testNamePattern="WouldYouRather.*round.*progression"
          
      - name: ğŸ—³ï¸ Test voting phases
        run: |
          cd backend
          npm test -- --testNamePattern="WouldYouRather.*voting.*phase"
          
      - name: ğŸ“Š Test results calculation
        run: |
          cd backend
          npm test -- --testNamePattern="WouldYouRather.*results"
          
      - name: ğŸ Test multi-round completion
        run: |
          cd backend
          npm test -- --testNamePattern="WouldYouRather.*multi.*round"

  # ============================================================================
  # Quick Draw Testing
  # ============================================================================
  test-quick-draw:
    name: ğŸ¨ Quick Draw
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ¨ Test drawing mechanics
        run: |
          cd backend
          npm test -- --testNamePattern="QuickDraw.*drawing.*mechanics"
          
      - name: â±ï¸ Test round timing
        run: |
          cd backend
          npm test -- --testNamePattern="QuickDraw.*timing"
          
      - name: ğŸ¯ Test guess processing
        run: |
          cd backend
          npm test -- --testNamePattern="QuickDraw.*guess.*processing"
          
      - name: ğŸ–Œï¸ Test canvas operations
        run: |
          cd backend
          npm test -- --testNamePattern="QuickDraw.*canvas"
          
      - name: ğŸ“ Test word prompts
        run: |
          cd backend
          npm test -- --testNamePattern="QuickDraw.*prompt"
          
      - name: ğŸ† Test scoring algorithm
        run: |
          cd backend
          npm test -- --testNamePattern="QuickDraw.*scoring"

  # ============================================================================
  # Cross-Game Integration Testing
  # ============================================================================
  test-game-integration:
    name: ğŸ”— Game Integration
    runs-on: ubuntu-latest
    needs: [test-two-truths, test-would-you-rather, test-quick-draw]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ”— Test lobby system integration
        run: |
          cd backend
          npm test -- --testNamePattern="lobby.*game.*integration"
          
      - name: ğŸ“¡ Test WebSocket game switching
        run: |
          cd backend
          npm test -- --testNamePattern="websocket.*game.*switching"
          
      - name: ğŸ‘¥ Test multi-player scenarios
        run: |
          cd backend
          npm test -- --testNamePattern="multi.*player.*scenarios"
          
      - name: ğŸ® Test game state persistence
        run: |
          cd backend
          npm test -- --testNamePattern="game.*state.*persistence"

  # ============================================================================
  # Performance Testing
  # ============================================================================
  test-performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: âš¡ Test WebSocket performance
        run: |
          echo "ğŸš€ Testing WebSocket performance..."
          # Start backend
          cd backend && npm start &
          BACKEND_PID=$!
          sleep 5
          
          # Install performance testing tools
          npm install -g wscat
          
          # Test concurrent connections (simulate 10 players)
          for i in {1..10}; do
            timeout 5s wscat -c ws://localhost:3001 &
          done
          wait
          
          # Cleanup
          kill $BACKEND_PID
          
      - name: ğŸ¨ Test canvas data throughput
        run: |
          echo "ğŸ¨ Testing canvas data throughput..."
          cd backend
          npm test -- --testNamePattern="performance.*canvas.*throughput"
          
      - name: ğŸ“Š Test concurrent game sessions
        run: |
          echo "ğŸ² Testing concurrent game sessions..."
          cd backend
          npm test -- --testNamePattern="performance.*concurrent.*sessions"

  # ============================================================================
  # Frontend Game Component Testing
  # ============================================================================
  test-frontend-games:
    name: ğŸ¨ Frontend Game Components
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ­ Test Two Truths component
        run: |
          cd frontend
          npm test -- --testNamePattern="TwoTruthsAndALie"
          
      - name: ğŸ¤” Test Would You Rather component
        run: |
          cd frontend
          npm test -- --testNamePattern="WouldYouRather"
          
      - name: ğŸ¨ Test Quick Draw component
        run: |
          cd frontend
          npm test -- --testNamePattern="QuickDraw"
          
      - name: ğŸ–Œï¸ Test Drawing Canvas component
        run: |
          cd frontend
          npm test -- --testNamePattern="DrawingCanvas"
          
      - name: ğŸ® Test Game Page routing
        run: |
          cd frontend
          npm test -- --testNamePattern="GamePage"

  # ============================================================================
  # Game Testing Summary
  # ============================================================================
  game-test-summary:
    name: ğŸ“Š Game Test Summary
    runs-on: ubuntu-latest
    needs: [test-two-truths, test-would-you-rather, test-quick-draw, test-game-integration, test-performance, test-frontend-games]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate test summary
        run: |
          echo "ğŸ² Party Games Test Suite Results:"
          echo "=================================="
          echo "ğŸ­ Two Truths and a Lie: ${{ needs.test-two-truths.result }}"
          echo "ğŸ¤” Would You Rather: ${{ needs.test-would-you-rather.result }}"
          echo "ğŸ¨ Quick Draw: ${{ needs.test-quick-draw.result }}"
          echo "ğŸ”— Game Integration: ${{ needs.test-game-integration.result }}"
          echo "âš¡ Performance Tests: ${{ needs.test-performance.result }}"
          echo "ğŸ¨ Frontend Components: ${{ needs.test-frontend-games.result }}"
          echo "=================================="
          
          if [[ "${{ needs.test-two-truths.result }}" == "success" && 
                "${{ needs.test-would-you-rather.result }}" == "success" && 
                "${{ needs.test-quick-draw.result }}" == "success" && 
                "${{ needs.test-game-integration.result }}" == "success" && 
                "${{ needs.test-performance.result }}" == "success" && 
                "${{ needs.test-frontend-games.result }}" == "success" ]]; then
            echo "ğŸ‰ All game tests passed! Platform is ready to party! ğŸ‰"
          else
            echo "âŒ Some game tests failed. Check the logs above."
            exit 1
          fi 
